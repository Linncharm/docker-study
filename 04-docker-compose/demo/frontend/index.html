<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Compose Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .user-list, .message-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item, .message-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Docker Compose 全栈应用 Demo</h1>

        <!-- 服务状态 -->
        <div class="grid">
            <div class="card">
                <h2>服务状态</h2>
                <div id="service-status">
                    <div class="loading">正在检查服务状态...</div>
                </div>
            </div>

            <div class="card">
                <h2>统计信息</h2>
                <div class="stats" id="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="user-count">-</div>
                        <div class="stat-label">用户总数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="queue-count">-</div>
                        <div class="stat-label">队列消息</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 功能区域 -->
        <div class="grid">
            <!-- 用户管理 -->
            <div class="card">
                <h2>用户管理 (PostgreSQL)</h2>
                <div class="form-group">
                    <label>姓名</label>
                    <input type="text" id="user-name" placeholder="输入姓名">
                </div>
                <div class="form-group">
                    <label>邮箱</label>
                    <input type="email" id="user-email" placeholder="输入邮箱">
                </div>
                <button onclick="createUser()">创建用户</button>
                <button onclick="loadUsers()" style="margin-left: 10px; background: #28a745;">刷新列表</button>
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 10px;">用户列表</h3>
                    <div class="user-list" id="user-list">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
            </div>

            <!-- Redis 缓存 -->
            <div class="card">
                <h2>缓存管理 (Redis)</h2>
                <div class="form-group">
                    <label>键名 (Key)</label>
                    <input type="text" id="cache-key" placeholder="输入键名">
                </div>
                <div class="form-group">
                    <label>值 (Value)</label>
                    <input type="text" id="cache-value" placeholder="输入值">
                </div>
                <div class="form-group">
                    <label>过期时间 (秒)</label>
                    <input type="number" id="cache-ttl" value="3600" min="1">
                </div>
                <button onclick="setCache()">设置缓存</button>
                <button onclick="getCache()" style="margin-left: 10px; background: #17a2b8;">获取缓存</button>
                <div id="cache-result" style="margin-top: 15px;"></div>
            </div>

            <!-- RabbitMQ 消息队列 -->
            <div class="card">
                <h2>消息队列 (RabbitMQ)</h2>
                <div class="form-group">
                    <label>消息内容</label>
                    <textarea id="message-content" rows="3" placeholder="输入要发送的消息"></textarea>
                </div>
                <button onclick="sendMessage()">发送消息</button>
                <button onclick="consumeMessage()" style="margin-left: 10px; background: #ffc107; color: #333;">消费消息</button>
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 10px;">消费的消息</h3>
                    <div class="message-list" id="message-list">
                        <div style="color: #666; padding: 10px;">暂无消息</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        // 检查服务状态
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                const statusHtml = `
                    <div style="line-height: 2;">
                        <div>PostgreSQL: <span class="status connected">已连接</span></div>
                        <div>Redis: <span class="status connected">已连接</span></div>
                        <div>RabbitMQ: <span class="status connected">已连接</span></div>
                        <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
                            最后检查: ${new Date(data.timestamp).toLocaleString('zh-CN')}
                        </div>
                    </div>
                `;
                document.getElementById('service-status').innerHTML = statusHtml;
            } catch (error) {
                document.getElementById('service-status').innerHTML = `
                    <div class="error">无法连接到后端服务</div>
                `;
            }
        }

        // 加载统计信息
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                const data = await response.json();
                document.getElementById('user-count').textContent = data.users;
                document.getElementById('queue-count').textContent = data.queueMessages;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // 加载用户列表
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/users`);
                const users = await response.json();
                const listHtml = users.length > 0
                    ? users.map(user => `
                        <div class="user-item">
                            <strong>${user.name}</strong><br>
                            <small>${user.email}</small>
                        </div>
                    `).join('')
                    : '<div style="color: #666; padding: 10px;">暂无用户</div>';
                document.getElementById('user-list').innerHTML = listHtml;
                loadStats();
            } catch (error) {
                document.getElementById('user-list').innerHTML = `
                    <div class="error">加载失败: ${error.message}</div>
                `;
            }
        }

        // 创建用户
        async function createUser() {
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;

            if (!name || !email) {
                alert('请填写姓名和邮箱');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });

                if (response.ok) {
                    document.getElementById('user-name').value = '';
                    document.getElementById('user-email').value = '';
                    await loadUsers();
                    alert('用户创建成功！');
                } else {
                    alert('创建失败');
                }
            } catch (error) {
                alert('创建失败: ' + error.message);
            }
        }

        // 设置缓存
        async function setCache() {
            const key = document.getElementById('cache-key').value;
            const value = document.getElementById('cache-value').value;
            const ttl = parseInt(document.getElementById('cache-ttl').value);

            if (!key || !value) {
                alert('请填写键名和值');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cache`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, value, ttl })
                });

                if (response.ok) {
                    document.getElementById('cache-result').innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">
                            缓存设置成功！Key: ${key}, Value: ${value}
                        </div>
                    `;
                }
            } catch (error) {
                alert('设置失败: ' + error.message);
            }
        }

        // 获取缓存
        async function getCache() {
            const key = document.getElementById('cache-key').value;

            if (!key) {
                alert('请填写键名');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cache/${key}`);
                const data = await response.json();

                document.getElementById('cache-result').innerHTML = `
                    <div style="background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px;">
                        <strong>Key:</strong> ${data.key}<br>
                        <strong>Value:</strong> ${data.value || '(不存在)'}
                    </div>
                `;
            } catch (error) {
                alert('获取失败: ' + error.message);
            }
        }

        // 发送消息
        async function sendMessage() {
            const message = document.getElementById('message-content').value;

            if (!message) {
                alert('请输入消息内容');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (response.ok) {
                    document.getElementById('message-content').value = '';
                    alert('消息已发送到队列！');
                    loadStats();
                }
            } catch (error) {
                alert('发送失败: ' + error.message);
            }
        }

        // 消费消息
        async function consumeMessage() {
            try {
                const response = await fetch(`${API_URL}/messages/consume`);
                const data = await response.json();

                if (data.message) {
                    const messageHtml = `
                        <div class="message-item">
                            <strong>消息内容:</strong> ${JSON.stringify(data.message, null, 2)}<br>
                            <small>消费时间: ${new Date().toLocaleString('zh-CN')}</small>
                        </div>
                    `;
                    document.getElementById('message-list').innerHTML = messageHtml + document.getElementById('message-list').innerHTML;
                    loadStats();
                } else {
                    alert('队列中暂无消息');
                }
            } catch (error) {
                alert('消费失败: ' + error.message);
            }
        }

        // 初始化
        checkHealth();
        loadUsers();
        loadStats();

        // 定时刷新
        setInterval(() => {
            checkHealth();
            loadStats();
        }, 5000);
    </script>
</body>
</html>
